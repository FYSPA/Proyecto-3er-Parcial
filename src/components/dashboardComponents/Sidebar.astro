---
import NavItem from '@components/dashboardComponents/NavItem.astro';
import { menuItems } from '@components/dashboardComponents/data/menu-items.js';
import House from '@components/icons/House.astro';
interface MenuItem {
  titulo: string;
  descripcion: string;
  descripcion_icono: string;
  texto_etiqueta: string;
  ruta_dinamica: string;
  icon: 'house' | 'dashboard' | 'logout';
}

const typedMenuItems: MenuItem[] = menuItems as MenuItem[];

const iconMap = {
  house: House,
} as const;

function formatRoute(ruta: string): string {
  return ruta.startsWith('/') ? ruta : `/${ruta}`;
}
---

<aside class="sidebar">
  <!-- Logo o branding -->
  <div class="sidebar-header">
    <img src="/logoVGS.svg" alt="LogoVGS" style="width: 60px; height: auto;">
  </div>

  <nav class="sidebar-nav">
    <ul class="menuList">
      {menuItems.map((item: any) => {
        const IconComponent = iconMap[item.icon as keyof typeof iconMap] as any;
        return (
          <li>
            <NavItem 
              href={formatRoute(item.ruta_dinamica)}
              icon={item.icon}
              iconComponent={IconComponent}
              iconAlt={item.descripcion_icono}
              label={item.texto_etiqueta}
              title={item.titulo}
            />
          </li>
        );
      })}
    </ul>
  </nav>

  <!-- Footer del sidebar -->
  <div class="sidebar-footer">
    <button id="logoutBtn" class="nav-item logout" title="Cerrar sesión">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      <span class="label">Salir</span>
    </button>
  </div>
</aside>

<style>
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 80px;
    height: 100vh;
    background-color: #1a1a1a;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    z-index: 999;
    overflow-y: auto;
    overflow-x: hidden;
    transition: background-color 0.3s ease, border-right-color 0.3s ease;
  }

  body.modo-claro .sidebar {
    background-color: #f5f5f5;
    border-right-color: #ddd;
  }

  body.modo-oscuro .sidebar {
    background-color: #1a1a1a;
    border-right-color: #333;
  }

  .sidebar-header {
    padding: 1.5rem 0;
    text-align: center;
    border-bottom: 1px solid #333;
    transition: border-color 0.3s ease;
  }

  body.modo-claro .sidebar-header {
    border-bottom-color: #ddd;
  }

  body.modo-oscuro .sidebar-header {
    border-bottom-color: #333;
  }

  .sidebar-nav {
    flex: 1;
    padding: 1rem 0;
    display: flex;
    flex-direction: column;
  }

  .menuList {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 0.5rem;
  }

  .menuList li {
    width: 100%;
    display: flex;
    justify-content: center;
  }

  .sidebar-footer {
    padding: 1rem 0;
    border-top: 1px solid #333;
    transition: border-color 0.3s ease;
  }

  body.modo-claro .sidebar-footer {
    border-top-color: #ddd;
  }

  body.modo-oscuro .sidebar-footer {
    border-top-color: #333;
  }

  .nav-item.logout {
    color: #ff6b6b;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 0;
    text-decoration: none;
    transition: color 0.3s ease, background-color 0.3s ease;
    position: relative;
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
  }

  .nav-item.logout:hover {
    background-color: #ff6b6b;
    color: #fff;
  }

  .icon {
    width: clamp(20px, 2.5vw, 24px);
    height: clamp(20px, 2.5vw, 24px);
    aspect-ratio: 1 / 1;
    object-fit: contain;
    object-position: center;
    display: block;
  }

  .label {
    font-size: 0.65rem;
    text-align: center;
    max-width: 70px;
    word-break: break-word;
    color: inherit;
  }

  /* Tooltip al pasar el mouse */
  .nav-item.logout::before {
    content: attr(title);
    position: absolute;
    left: 100%;
    margin-left: 0.5rem;
    background-color: #333;
    color: #fff;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 1001;
  }

  body.modo-claro .nav-item.logout::before {
    background-color: #ddd;
    color: #333;
  }

  .nav-item.logout:hover::before {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 70px;
    }

    .label {
      font-size: 0.6rem;
      max-width: 60px;
    }

    .icon { width: 20px; height: 20px; }
  }

  @media (prefers-reduced-motion: reduce) {
    .sidebar, .sidebar-header, .sidebar-footer, .nav-item.logout::before { transition: none; }
  }
</style>

<script type="module" src="/scripts/auth.js"></script>
<script type="module">
  function activateCurrentPage() {
    const currentPath = window.location.pathname;
    document.querySelectorAll('.sidebar-nav .nav-item').forEach((el) => {
      el.classList.remove('active');
      const href = el.getAttribute('href');
      if (href === currentPath || currentPath.endsWith(href)) {
        el.classList.add('active');
      }
    });
  }

  // Activar al cargar
  activateCurrentPage();

  // Activar al cambiar ruta (navegación con popstate)
  window.addEventListener('popstate', activateCurrentPage);

  // Activar al hacer click en un link
  document.addEventListener('click', (e) => {
    if (e.target.closest('.sidebar-nav .nav-item')) {
      setTimeout(activateCurrentPage, 100);
    }
  });
</script>
